<h3><?=$data['article_page']['title'] ?></h3><br/>


<?php if ($data['article_page']['date_published']) echo $data['article_page']['date_published']; ?>
&nbsp;&nbsp;&nbsp;
<b>Author : </b>
<?php if ($data['article_page']['author']) {echo $data['article_page']['author'];} ?>
&nbsp;&nbsp;
<br/><br/>

<?php if ($data['article_images']) {
        foreach( $data['article_images'] as $img_name) { ?>
    <img src="/webroot/img/articles/<?= $img_name['full_name'] ?>" alt="" style="width: 24%; display:inline-block;">
<?php } } ?>

<br/><br/>

<?php if ($data['article_page']['text']) echo  $data['article_page']['text']; ?>

<br/><br/>

<p>
    <b>Online: <span id="online">0</span></b>
</p>
<p>
    <b>Visited: <span id="visited">0</span></b>
</p>

<p>
    <b>Tags: </b>
    <?php
            if ( $data['article_page']['tags']) {
                foreach( $data['article_page']['tags'] as $tag){
                    echo ' <b><a href="/articles/filter/?tags[]=' . $tag . '" >' . $tag . ' </a></b> &nbsp;' ;
            }
        }
    ?>
</p>





<hr>
<h4>Комментарии</h4>
<hr>


<div id="comments" style="padding: 5px 20px; ">


    <div id="0"  class="comment" >
        <?php if (Session::get('role')) {  ?>
        <p>Вы можете оставить свой комментарий:</p>
        <textarea name="comm_input" class="comm_input"  style="display: block; width: 100%; padding:10px; margin: 5px 0px 0px 0px;"></textarea>
        <span class="comm_send_btn btn btn-sm btn-default" onclick=""  style="display:inline-block; ;">Отправить</span>

        <?php  } else { ?>
        <p>Комментарии могут оставлять только зарегистрированные пользователи.</p>
        <?php  }  ?>

    </div>



    <div id="comment_base" data_parent_id=""  class="comment"  align="left"
    style="padding: 10px 0px 10px 0px ; display: none; ">

        <b><span class="comm_login" style="margin: 0px 10px;">  </span></b>
        <span class="comm_date"  style="margin: 0px 10px;">  </span>

        <?php  if (Session::get('role')) {  ?>
        <!--<span class="comm_like_btn  btn btn-sm btn-default"   style="margin: 0px 5px;"><b> + </b></span>-->
            <img src="/webroot/img/icons/thumb_up.png" alt="" class="comm_like_btn  btn btn-sm "   style="margin: 0px 0px 0px 20px;" >
        <?php  } else { ?>
             <img src="/webroot/img/icons/thumb_up.png" alt="" class=""   style="margin: 0px 0px 0px 20px;" >
        <?php  }  ?>

        <span class="comm_like_count"  style="margin: 0px 20px 0px 0px;">  </span>

        <span class="id_parent" >  </span>
        <span class="id" >  </span>

        <div name="" class="comm_text"  style="width: 100%; background-color: #fff; border: 1px solid #aaa; padding:10px;">   </div>

        <?php if (Session::get('role')) {  ?>
                <textarea name="comm_input" class="comm_input"  style="display: none; width: calc(100% - 30px); padding:10px; margin: 5px 0px 0px 30px;"></textarea>

                <span class="comm_send_btn btn btn-sm btn-default" onclick=""  style="display: none; margin-left: 30px;">Отправить</span>
                <span class="comm_reply_btn btn btn-sm btn-default" onclick="" style="display: inline-block;">Оставить комментарий</span>

        <?php  } ?>

        <!--<img src="/webroot/img/icons/thumb_up.png" alt="" class=""   style="margin: 0px 5px 0px 40px;" >-->
        <!--<span class="comm_like_text "  style="margin: 0px 5px 0px 20px;"> Понравилось: </span>-->

        <!--<hr>-->

    </div>


    <div    id="user_id"  data_user_id="<?= $data['user']['id'] ?>" style="display: none;" ></div>
    <div    id="user_login"  data_user_login="<?= $data['user']['login'] ?>" style="display: none;" ></div>
    <div    id="article_id"  data_article_id="<?= $data['article_page']['id'] ?>" style="display: none;" ></div>


</div>



<script>

    document.addEventListener("DOMContentLoaded", commentsGet);

    function commentsGet() {

        $comments_wrapp = $('#comments');
        $comment_base_element = $('#comment_base');

        var user_id = $('#user_id').attr('data_user_id');
        var article_id = $('#article_id').attr('data_article_id');
        if (article_id) {
            var data = {};
            var uri = '/article_page/comments_get_ajax/' + article_id + '/';
            myAjax(uri, data, commentsReturn, commentsReturnErr);
        }

        function commentsReturn(data) {

            if (data) {
                $('div[data_base_element="no_base_element"]').remove();

                var comments = JSON.parse(data);
                var commLength = comments.length;

                for (i = 0; i < commLength; i++) {

                    $row = comments[i];

                    $comm_clone = $comment_base_element.clone();

                    $comm_clone.attr('data_base_element', 'no_base_element');
                    $comm_clone.css('display', 'block');
                    $comm_clone.css('padding-left', 30 * $row['nested_level'] + 'px');
                    $comm_clone.attr('id', $row['id_comment']);
                    $comm_clone.attr('data_parent_id', $row['id_parent_comment']);
                    $comm_clone.find('.comm_login').text($row['login']);
                    $comm_clone.find('.comm_date').text($row['date']);
                    $comm_clone.find('.comm_like_count').text($row['like_count']);
                    $comm_clone.find('.comm_text').text($row['text']);
                    // $comm_clone.find('.comm_input').text($row['nested_level']);

                    $comm_clone.find('.id_parent').text($row['id_parent_comment']);
                    $comm_clone.find('.id').text($row['id_comment']);

                    $comments_wrapp.append($comm_clone);
                    // console.log(comments[i]['id_comment']);
                }
            }

            $('.comment .comm_send_btn').on('click', function () {
                $this_div = $(this).parent();
                var id = $this_div.attr('id');
                var text = $this_div.find('.comm_input').val();
                $this_div.find('.comm_input').val('');
                text = text.trim();

                if (text != '') {
                    var data = {
                        'text': text,
                        'id_parent_comment': id,
                        'id_user': user_id,
                        'id_article': article_id
                    };

                    var uri = '/article_page/comment_add_ajax/' + article_id + '/';
                    myAjax(uri, data, commentsReturn, commentsReturnErr);
                }

            });

            $('.comment .comm_reply_btn').on('click', function () {
                $this_div = $(this).parent();
                var id = $this_div.attr('id');
                $this_div.find('.comm_input').css('display', 'block');
                $this_div.find('.comm_send_btn').css('display', 'inline-block');
                $this_div.find('.comm_reply_btn').css('display', 'none');
            });

            $('.comment .comm_like_btn').on('click', function () {
                $this_div = $(this).parent();
                var id = $this_div.attr('id');

                var data = {};
                var uri = '/article_page/comment_like_ajax/' + id + '/' + user_id + '/';
                myAjax(uri, data, commentLike, commentsReturnErr);

                function commentLike(data){
                    var like_count = $this_div.find('.comm_like_count').text();
                    like_count = parseInt(like_count);
                    if (data == 1) {
                        $this_div.find('.comm_like_count').text( like_count + 1 );
                    }
                }
            });

        }

        function commentsReturnErr() {
            alert('Error');
        }

    }

</script>





















